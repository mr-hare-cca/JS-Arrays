name: Unit 8.5 Autograding (Prompts + console.log)

on:
  push:
  workflow_dispatch:

jobs:
  autograde:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Jest
        run: |
          npm init -y >/dev/null 2>&1 || true
          npm install --save-dev jest@29

      - name: Write jest config
        run: |
          cat > jest.config.cjs <<'EOF'
          module.exports = {
            testEnvironment: 'node',
            testMatch: ['**/__tests__/**/*.test.cjs']
          };
          EOF

      - name: Write tests
        run: |
          mkdir -p __tests__
          cat > __tests__/unit-8-5-arrays.test.cjs <<'EOF'
          const fs = require('fs');
          const path = require('path');

          const scriptPath = path.resolve(process.cwd(), 'script.js');
          const source = fs.existsSync(scriptPath)
            ? fs.readFileSync(scriptPath, 'utf8')
            : '';

          function runWithPrompts(promptValues) {
            if (!fs.existsSync(scriptPath)) {
              throw new Error('script.js not found in repository root.');
            }

            const originalPrompt = global.prompt;
            const originalConsoleLog = console.log;

            let index = 0;
            global.prompt = jest.fn(() => {
              if (index < promptValues.length) {
                return String(promptValues[index++]);
              }
              return '';
            });

            const logs = [];
            console.log = (...args) => logs.push(args.join(' '));

            delete require.cache[scriptPath];
            try {
              require(scriptPath);
            } finally {
              console.log = originalConsoleLog;
              global.prompt = originalPrompt;
            }

            return logs.map(String);
          }

          describe('Unit 8.5 – Arrays (prompts + console.log)', () => {
            test('green action lines', () => {
              const logs = runWithPrompts(['GrEeN', 1, 2, 3, 4, 5]);
              const actions = logs.filter(l => l.startsWith('Action:'));
              expect(actions.slice(0, 5)).toEqual([
                'Action: Go',
                'Action: Go',
                'Action: Go',
                'Action: Go',
                'Action: Go'
              ]);
            });

            test('yellow action lines', () => {
              const logs = runWithPrompts(['YELLOW', 1, 2, 3, 4, 5]);
              const actions = logs.filter(l => l.startsWith('Action:'));
              expect(actions.slice(0, 5)).toEqual([
                'Action: Slow',
                'Action: Slow',
                'Action: Slow',
                'Action: Slow',
                'Action: Slow'
              ]);
            });

            test('red action lines', () => {
              const logs = runWithPrompts(['red', 1, 2, 3, 4, 5]);
              const actions = logs.filter(l => l.startsWith('Action:'));
              expect(actions.slice(0, 5)).toEqual([
                'Action: Stop',
                'Action: Stop',
                'Action: Stop',
                'Action: Stop',
                'Action: Stop'
              ]);
            });

            test('invalid color message', () => {
              const logs = runWithPrompts(['blue', 1, 2, 3, 4, 5]);
              expect(logs.map(l => l.toLowerCase())).toContain('invalid color');
              expect(logs.filter(l => l.startsWith('Action:')).length).toBe(0);
            });

            test('average and even count are correct', () => {
              const logs = runWithPrompts(['green', 2, 4, 6, 8, 10]);
              expect(logs).toContain('Average: 6');
              expect(logs).toContain('Even count: 5');
            });

            test('script uses array for numbers', () => {
              expect(source).toMatch(/\[[^\]]*\]/);
              expect(source).toMatch(/push\s*\(/);
            });
          });
          EOF

      # === Graded steps ===
      - id: t_green_action
        name: green action lines
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: green action lines
          command: npx jest --runInBand --testNamePattern "green action lines$"
          timeout: 60
          max-score: 15

      - id: t_yellow_action
        name: yellow action lines
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: yellow action lines
          command: npx jest --runInBand --testNamePattern "yellow action lines$"
          timeout: 60
          max-score: 15

      - id: t_red_action
        name: red action lines
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: red action lines
          command: npx jest --runInBand --testNamePattern "red action lines$"
          timeout: 60
          max-score: 15

      - id: t_invalid_color
        name: invalid color message
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: invalid color message
          command: npx jest --runInBand --testNamePattern "invalid color message$"
          timeout: 60
          max-score: 10

      - id: t_avg_even
        name: average and even count are correct
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: average and even count are correct
          command: npx jest --runInBand --testNamePattern "average and even count are correct$"
          timeout: 60
          max-score: 30

      - id: t_array_usage
        name: script uses array for numbers
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: script uses array for numbers
          command: npx jest --runInBand --testNamePattern "script uses array for numbers$"
          timeout: 60
          max-score: 15

      # === Combined summary using step outputs ===
      - name: Build & publish combined summary
        shell: bash
        run: |
          echo "# Unit 8.5 Autograder Summary" >> $GITHUB_STEP_SUMMARY
          total=0
          earned=0

          declare -A scores=( ["t_green_action"]=15 ["t_yellow_action"]=15 ["t_red_action"]=15 ["t_invalid_color"]=10 ["t_avg_even"]=30 ["t_array_usage"]=15 )
          declare -A names=( ["t_green_action"]="green action lines" ["t_yellow_action"]="yellow action lines" ["t_red_action"]="red action lines" ["t_invalid_color"]="invalid color message" ["t_avg_even"]="average and even count are correct" ["t_array_usage"]="script uses array for numbers" )

          for id in "${!scores[@]}"; do
            total=$((total + scores[$id]))
            result="${{ steps.${id}.outputs.result }}"
            if [[ "$result" == *"pass"* ]]; then
              earned=$((earned + scores[$id]))
              echo "✅ ${names[$id]} (${scores[$id]} pts)" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ ${names[$id]} (${scores[$id]} pts)" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Score: ${earned}/${total}**" >> $GITHUB_STEP_SUMMARY

      # === Prepare reporter env ===
      - name: Prepare reporter env
        id: prepEnv
        shell: bash
        run: |
          echo "T_GREEN_ACTION_RESULTS=${{ steps.t_green_action.outputs.result }}" >> "$GITHUB_ENV"
          echo "T_YELLOW_ACTION_RESULTS=${{ steps.t_yellow_action.outputs.result }}" >> "$GITHUB_ENV"
          echo "T_RED_ACTION_RESULTS=${{ steps.t_red_action.outputs.result }}" >> "$GITHUB_ENV"
          echo "T_INVALID_COLOR_RESULTS=${{ steps.t_invalid_color.outputs.result }}" >> "$GITHUB_ENV"
          echo "T_AVG_EVEN_RESULTS=${{ steps.t_avg_even.outputs.result }}" >> "$GITHUB_ENV"
          echo "T_ARRAY_USAGE_RESULTS=${{ steps.t_array_usage.outputs.result }}" >> "$GITHUB_ENV"

      # === Report to Classroom ===
      - name: Report grades
        uses: classroom-resources/autograding-grading-reporter@v1
        with:
          runners: 't_green_action,t_yellow_action,t_red_action,t_invalid_color,t_avg_even,t_array_usage'
          token: ${{ github.token }}
